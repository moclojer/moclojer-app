shadow$provide.module$node_modules$$supabase$realtime_js$dist$main$RealtimeClient=function(global,require,module,exports){var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value)})}return new (P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}
function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};global=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{"default":mod}};Object.defineProperty(exports,"__esModule",{value:!0});const websocket_1=require("module$node_modules$websocket$lib$browser"),constants_1=require("module$node_modules$$supabase$realtime_js$dist$main$lib$constants"),timer_1=global(require("module$node_modules$$supabase$realtime_js$dist$main$lib$timer")),
serializer_1=global(require("module$node_modules$$supabase$realtime_js$dist$main$lib$serializer")),RealtimeChannel_1=global(require("module$node_modules$$supabase$realtime_js$dist$main$RealtimeChannel")),noop=()=>{};class RealtimeClient{constructor(endPoint,options){var _a;this.accessToken=null;this.channels=[];this.endPoint="";this.headers=constants_1.DEFAULT_HEADERS;this.params={};this.timeout=constants_1.DEFAULT_TIMEOUT;this.transport=websocket_1.w3cwebsocket;this.heartbeatIntervalMs=3E4;this.heartbeatTimer=
void 0;this.pendingHeartbeatRef=null;this.ref=0;this.logger=noop;this.conn=null;this.sendBuffer=[];this.serializer=new serializer_1.default;this.stateChangeCallbacks={open:[],close:[],error:[],message:[]};this.eventsPerSecondLimitMs=100;this.inThrottle=!1;this.endPoint=`${endPoint}/${constants_1.TRANSPORTS.websocket}`;if(null===options||void 0===options?0:options.params)this.params=options.params;if(null===options||void 0===options?0:options.headers)this.headers=Object.assign(Object.assign({},this.headers),
options.headers);if(null===options||void 0===options?0:options.timeout)this.timeout=options.timeout;if(null===options||void 0===options?0:options.logger)this.logger=options.logger;if(null===options||void 0===options?0:options.transport)this.transport=options.transport;if(null===options||void 0===options?0:options.heartbeatIntervalMs)this.heartbeatIntervalMs=options.heartbeatIntervalMs;if(endPoint=null===(_a=null===options||void 0===options?void 0:options.params)||void 0===_a?void 0:_a.eventsPerSecond)this.eventsPerSecondLimitMs=
Math.floor(1E3/endPoint);this.reconnectAfterMs=(null===options||void 0===options?0:options.reconnectAfterMs)?options.reconnectAfterMs:tries=>[1E3,2E3,5E3,1E4][tries-1]||1E4;this.encode=(null===options||void 0===options?0:options.encode)?options.encode:(payload,callback)=>callback(JSON.stringify(payload));this.decode=(null===options||void 0===options?0:options.decode)?options.decode:this.serializer.decode.bind(this.serializer);this.reconnectTimer=new timer_1.default(()=>__awaiter(this,void 0,void 0,
function*(){this.disconnect();this.connect()}),this.reconnectAfterMs)}connect(){this.conn||(this.conn=new this.transport(this._endPointURL(),[],null,this.headers),this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=error=>this._onConnError(error),this.conn.onmessage=event=>this._onConnMessage(event),this.conn.onclose=event=>this._onConnClose(event))}disconnect(code,reason){this.conn&&(this.conn.onclose=function(){},code?this.conn.close(code,null!==reason&&
void 0!==reason?reason:""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset())}getChannels(){return this.channels}removeChannel(channel){return __awaiter(this,void 0,void 0,function*(){const status=yield channel.unsubscribe();0===this.channels.length&&this.disconnect();return status})}removeAllChannels(){return __awaiter(this,void 0,void 0,function*(){const values_1=yield Promise.all(this.channels.map(channel=>channel.unsubscribe()));
this.disconnect();return values_1})}log(kind,msg,data){this.logger(kind,msg,data)}connectionState(){switch(this.conn&&this.conn.readyState){case constants_1.SOCKET_STATES.connecting:return constants_1.CONNECTION_STATE.Connecting;case constants_1.SOCKET_STATES.open:return constants_1.CONNECTION_STATE.Open;case constants_1.SOCKET_STATES.closing:return constants_1.CONNECTION_STATE.Closing;default:return constants_1.CONNECTION_STATE.Closed}}isConnected(){return this.connectionState()===constants_1.CONNECTION_STATE.Open}channel(topic,
params={config:{}}){this.isConnected()||this.connect();topic=new RealtimeChannel_1.default(`realtime:${topic}`,params,this);this.channels.push(topic);return topic}push(data){const {topic,event,payload,ref}=data;let callback=()=>{this.encode(data,result=>{var _a;null===(_a=this.conn)||void 0===_a?void 0:_a.send(result)})};this.log("push",`${topic} ${event} (${ref})`,payload);if(this.isConnected())if(["broadcast","presence","postgres_changes"].includes(event)){if(this._throttle(callback)())return"rate limited"}else callback();
else this.sendBuffer.push(callback)}setAuth(token){this.accessToken=token;this.channels.forEach(channel=>{token&&channel.updateJoinPayload({access_token:token});channel.joinedOnce&&channel._isJoined()&&channel._push(constants_1.CHANNEL_EVENTS.access_token,{access_token:token})})}_makeRef(){let newRef=this.ref+1;this.ref=newRef===this.ref?0:newRef;return this.ref.toString()}_leaveOpenTopic(topic){let dupChannel=this.channels.find(c=>c.topic===topic&&(c._isJoined()||c._isJoining()));dupChannel&&(this.log("transport",
`leaving duplicate topic "${topic}"`),dupChannel.unsubscribe())}_remove(channel){this.channels=this.channels.filter(c=>c._joinRef()!==channel._joinRef())}_endPointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:constants_1.VSN}))}_onConnMessage(rawMessage){this.decode(rawMessage.data,msg=>{let {topic,event,payload,ref}=msg;if(ref&&ref===this.pendingHeartbeatRef||event===(null===payload||void 0===payload?void 0:payload.type))this.pendingHeartbeatRef=null;this.log("receive",
`${payload.status||""} ${topic} ${event} ${ref&&"("+ref+")"||""}`,payload);this.channels.filter(channel=>channel._isMember(topic)).forEach(channel=>channel._trigger(event,payload,ref));this.stateChangeCallbacks.message.forEach(callback=>callback(msg))})}_onConnOpen(){this.log("transport",`connected to ${this._endPointURL()}`);this._flushSendBuffer();this.reconnectTimer.reset();this.heartbeatTimer&&clearInterval(this.heartbeatTimer);this.heartbeatTimer=setInterval(()=>this._sendHeartbeat(),this.heartbeatIntervalMs);
this.stateChangeCallbacks.open.forEach(callback=>callback())}_onConnClose(event){this.log("transport","close",event);this._triggerChanError();this.heartbeatTimer&&clearInterval(this.heartbeatTimer);this.reconnectTimer.scheduleTimeout();this.stateChangeCallbacks.close.forEach(callback=>callback(event))}_onConnError(error){this.log("transport",error.message);this._triggerChanError();this.stateChangeCallbacks.error.forEach(callback=>callback(error))}_triggerChanError(){this.channels.forEach(channel=>
channel._trigger(constants_1.CHANNEL_EVENTS.error))}_appendParams(url,params){if(0===Object.keys(params).length)return url;const prefix=url.match(/\?/)?"\x26":"?";params=new URLSearchParams(params);return`${url}${prefix}${params}`}_flushSendBuffer(){this.isConnected()&&0<this.sendBuffer.length&&(this.sendBuffer.forEach(callback=>callback()),this.sendBuffer=[])}_sendHeartbeat(){var _a;this.isConnected()&&(this.pendingHeartbeatRef?(this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),
null===(_a=this.conn)||void 0===_a?void 0:_a.close(constants_1.WS_CLOSE_NORMAL,"hearbeat timeout")):(this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.setAuth(this.accessToken)))}_throttle(callback,eventsPerSecondLimitMs=this.eventsPerSecondLimitMs){return()=>{if(this.inThrottle)return!0;callback();0<eventsPerSecondLimitMs&&(this.inThrottle=!0,setTimeout(()=>{this.inThrottle=!1},eventsPerSecondLimitMs));return!1}}}
exports.default=RealtimeClient}
//# sourceMappingURL=module$node_modules$$supabase$realtime_js$dist$main$RealtimeClient.js.map
