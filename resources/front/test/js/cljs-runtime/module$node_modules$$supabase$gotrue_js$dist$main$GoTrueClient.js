shadow$provide.module$node_modules$$supabase$gotrue_js$dist$main$GoTrueClient=function(global,require,module,exports){var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value)})}return new (P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}
function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};global=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{"default":mod}};Object.defineProperty(exports,"__esModule",{value:!0});const GoTrueAdminApi_1=global(require("module$node_modules$$supabase$gotrue_js$dist$main$GoTrueAdminApi")),constants_1=require("module$node_modules$$supabase$gotrue_js$dist$main$lib$constants"),
errors_1=require("module$node_modules$$supabase$gotrue_js$dist$main$lib$errors"),fetch_1=require("module$node_modules$$supabase$gotrue_js$dist$main$lib$fetch"),helpers_1=require("module$node_modules$$supabase$gotrue_js$dist$main$lib$helpers"),local_storage_1=global(require("module$node_modules$$supabase$gotrue_js$dist$main$lib$local_storage"));(0,require("module$node_modules$$supabase$gotrue_js$dist$main$lib$polyfills").polyfillGlobalThis)();const DEFAULT_OPTIONS={url:constants_1.GOTRUE_URL,storageKey:constants_1.STORAGE_KEY,
autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:constants_1.DEFAULT_HEADERS,flowType:"implicit"};class GoTrueClient{constructor(options){var _a;this.stateChangeEmitters=new Map;this.initializePromise=this.refreshingDeferred=this.visibilityChangedCallback=this.autoRefreshTicker=null;this.detectSessionInUrl=!0;this.broadcastChannel=null;options=Object.assign(Object.assign({},DEFAULT_OPTIONS),options);this.inMemorySession=null;this.storageKey=options.storageKey;this.autoRefreshToken=
options.autoRefreshToken;this.persistSession=options.persistSession;this.storage=options.storage||local_storage_1.default;this.admin=new GoTrueAdminApi_1.default({url:options.url,headers:options.headers,fetch:options.fetch});this.url=options.url;this.headers=options.headers;this.fetch=(0,helpers_1.resolveFetch)(options.fetch);this.detectSessionInUrl=options.detectSessionInUrl;this.flowType=options.flowType;this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),
challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)};if((0,helpers_1.isBrowser)()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(e){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",e)}null===
(_a=this.broadcastChannel)||void 0===_a?void 0:_a.addEventListener("message",event=>{this._notifyAllSubscribers(event.data.event,event.data.session,!1)})}this.initialize()}initialize(){this.initializePromise||(this.initializePromise=this._initialize());return this.initializePromise}_initialize(){return __awaiter(this,void 0,void 0,function*(){if(this.initializePromise)return this.initializePromise;try{const isPKCEFlow=yield this._isPKCEFlow();if(this.detectSessionInUrl&&this._isImplicitGrantFlow()||
isPKCEFlow){const {data,error}=yield this._getSessionFromUrl(isPKCEFlow);if(error)return yield this._removeSession(),{error};const {session,redirectType}=data;yield this._saveSession(session);setTimeout(()=>{"recovery"===redirectType?this._notifyAllSubscribers("PASSWORD_RECOVERY",session):this._notifyAllSubscribers("SIGNED_IN",session)},0);return{error:null}}yield this._recoverAndRefresh();return{error:null}}catch(error){return(0,errors_1.isAuthError)(error)?{error}:{error:new errors_1.AuthUnknownError("Unexpected error during initialization",
error)}}finally{yield this._handleVisibilityChange()}})}signUp(credentials){var _a,_b,_c;return __awaiter(this,void 0,void 0,function*(){try{yield this._removeSession();let res;if("email"in credentials){const {email,password,options}=credentials;res=yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:null===options||void 0===options?void 0:options.emailRedirectTo,body:{email,password,data:null!==(_a=null===options||void 0===options?void 0:options.data)&&
void 0!==_a?_a:{},gotrue_meta_security:{captcha_token:null===options||void 0===options?void 0:options.captchaToken}},xform:fetch_1._sessionResponse})}else if("phone"in credentials){const {phone,password,options}=credentials;res=yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone,password,data:null!==(_b=null===options||void 0===options?void 0:options.data)&&void 0!==_b?_b:{},channel:null!==(_c=null===options||void 0===options?void 0:options.channel)&&
void 0!==_c?_c:"sms",gotrue_meta_security:{captcha_token:null===options||void 0===options?void 0:options.captchaToken}},xform:fetch_1._sessionResponse})}else throw new errors_1.AuthInvalidCredentialsError("You must provide either an email or phone number and a password");const {data,error}=res;if(error||!data)return{data:{user:null,session:null},error};const session=data.session,user=data.user;data.session&&(yield this._saveSession(data.session),this._notifyAllSubscribers("SIGNED_IN",session));return{data:{user,
session},error:null}}catch(error){if((0,errors_1.isAuthError)(error))return{data:{user:null,session:null},error};throw error;}})}signInWithPassword(credentials){return __awaiter(this,void 0,void 0,function*(){try{yield this._removeSession();let res;if("email"in credentials){const {email,password,options}=credentials;res=yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email,password,gotrue_meta_security:{captcha_token:null===options||
void 0===options?void 0:options.captchaToken}},xform:fetch_1._sessionResponse})}else if("phone"in credentials){const {phone,password,options}=credentials;res=yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone,password,gotrue_meta_security:{captcha_token:null===options||void 0===options?void 0:options.captchaToken}},xform:fetch_1._sessionResponse})}else throw new errors_1.AuthInvalidCredentialsError("You must provide either an email or phone number and a password");
const {data,error}=res;if(error||!data)return{data:{user:null,session:null},error};data.session&&(yield this._saveSession(data.session),this._notifyAllSubscribers("SIGNED_IN",data.session));return{data,error}}catch(error){if((0,errors_1.isAuthError)(error))return{data:{user:null,session:null},error};throw error;}})}signInWithOAuth(credentials){var _a,_b,_c,_d;return __awaiter(this,void 0,void 0,function*(){yield this._removeSession();return yield this._handleProviderSignIn(credentials.provider,{redirectTo:null===
(_a=credentials.options)||void 0===_a?void 0:_a.redirectTo,scopes:null===(_b=credentials.options)||void 0===_b?void 0:_b.scopes,queryParams:null===(_c=credentials.options)||void 0===_c?void 0:_c.queryParams,skipBrowserRedirect:null===(_d=credentials.options)||void 0===_d?void 0:_d.skipBrowserRedirect})})}exchangeCodeForSession(authCode){return __awaiter(this,void 0,void 0,function*(){const codeVerifier=yield(0,helpers_1.getItemAsync)(this.storage,`${this.storageKey}-code-verifier`),{data,error}=yield(0,fetch_1._request)(this.fetch,
"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:authCode,code_verifier:codeVerifier},xform:fetch_1._sessionResponse});yield(0,helpers_1.removeItemAsync)(this.storage,`${this.storageKey}-code-verifier`);if(error||!data)return{data:{user:null,session:null},error};data.session&&(yield this._saveSession(data.session),this._notifyAllSubscribers("SIGNED_IN",data.session));return{data,error}})}signInWithIdToken(credentials){return __awaiter(this,void 0,void 0,function*(){yield this._removeSession();
try{const {options,provider,token,nonce}=credentials,res=yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider,id_token:token,nonce,gotrue_meta_security:{captcha_token:null===options||void 0===options?void 0:options.captchaToken}},xform:fetch_1._sessionResponse}),{data,error}=res;if(error||!data)return{data:{user:null,session:null},error};data.session&&(yield this._saveSession(data.session),this._notifyAllSubscribers("SIGNED_IN",data.session));
return{data,error}}catch(error){if((0,errors_1.isAuthError)(error))return{data:{user:null,session:null},error};throw error;}})}signInWithOtp(credentials){var _a,_b,_c,_d,_e;return __awaiter(this,void 0,void 0,function*(){try{yield this._removeSession();if("email"in credentials){const {email,options}=credentials;var codeChallenge=null;if("pkce"===this.flowType){const codeVerifier=(0,helpers_1.generatePKCEVerifier)();yield(0,helpers_1.setItemAsync)(this.storage,`${this.storageKey}-code-verifier`,codeVerifier);
codeChallenge=yield(0,helpers_1.generatePKCEChallenge)(codeVerifier)}const {error}=yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email,data:null!==(_a=null===options||void 0===options?void 0:options.data)&&void 0!==_a?_a:{},create_user:null!==(_b=null===options||void 0===options?void 0:options.shouldCreateUser)&&void 0!==_b?_b:!0,gotrue_meta_security:{captcha_token:null===options||void 0===options?void 0:options.captchaToken},code_challenge:codeChallenge,
code_challenge_method:codeChallenge?"s256":null},redirectTo:null===options||void 0===options?void 0:options.emailRedirectTo});return{data:{user:null,session:null},error}}if("phone"in credentials){const {phone,options}=credentials;({error:codeChallenge}=yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone,data:null!==(_c=null===options||void 0===options?void 0:options.data)&&void 0!==_c?_c:{},create_user:null!==(_d=null===options||void 0===options?void 0:
options.shouldCreateUser)&&void 0!==_d?_d:!0,gotrue_meta_security:{captcha_token:null===options||void 0===options?void 0:options.captchaToken},channel:null!==(_e=null===options||void 0===options?void 0:options.channel)&&void 0!==_e?_e:"sms"}}));return{data:{user:null,session:null},error:codeChallenge}}throw new errors_1.AuthInvalidCredentialsError("You must provide either an email or phone number.");}catch(error){if((0,errors_1.isAuthError)(error))return{data:{user:null,session:null},error};throw error;
}})}verifyOtp(params){var _a,_b;return __awaiter(this,void 0,void 0,function*(){try{yield this._removeSession();const {data,error}=yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},params),{gotrue_meta_security:{captcha_token:null===(_a=params.options)||void 0===_a?void 0:_a.captchaToken}}),redirectTo:null===(_b=params.options)||void 0===_b?void 0:_b.redirectTo,xform:fetch_1._sessionResponse});if(error)throw error;if(!data)throw Error("An error occurred on token verification.");
const session=data.session,user=data.user;if(null===session||void 0===session?0:session.access_token)yield this._saveSession(session),this._notifyAllSubscribers("SIGNED_IN",session);return{data:{user,session},error:null}}catch(error){if((0,errors_1.isAuthError)(error))return{data:{user:null,session:null},error};throw error;}})}signInWithSSO(params){var _a,_b,_c;return __awaiter(this,void 0,void 0,function*(){try{return yield this._removeSession(),yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/sso`,
{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in params?{provider_id:params.providerId}:null),"domain"in params?{domain:params.domain}:null),{redirect_to:null!==(_b=null===(_a=params.options)||void 0===_a?void 0:_a.redirectTo)&&void 0!==_b?_b:void 0}),(null===(_c=null===params||void 0===params?void 0:params.options)||void 0===_c?0:_c.captchaToken)?{gotrue_meta_security:{captcha_token:params.options.captchaToken}}:null),{skip_http_redirect:!0}),headers:this.headers,
xform:fetch_1._ssoResponse})}catch(error){if((0,errors_1.isAuthError)(error))return{data:null,error};throw error;}})}getSession(){return __awaiter(this,void 0,void 0,function*(){yield this.initializePromise;let currentSession=null;if(this.persistSession){const maybeSession=yield(0,helpers_1.getItemAsync)(this.storage,this.storageKey);null!==maybeSession&&(this._isValidSession(maybeSession)?currentSession=maybeSession:yield this._removeSession())}else currentSession=this.inMemorySession;if(!currentSession)return{data:{session:null},
error:null};if(!(currentSession.expires_at&&currentSession.expires_at<=Date.now()/1E3))return{data:{session:currentSession},error:null};const {session,error}=yield this._callRefreshToken(currentSession.refresh_token);return error?{data:{session:null},error}:{data:{session},error:null}})}getUser(jwt){var _a,_b;return __awaiter(this,void 0,void 0,function*(){try{if(!jwt){const {data,error}=yield this.getSession();if(error)throw error;jwt=null!==(_b=null===(_a=data.session)||void 0===_a?void 0:_a.access_token)&&
void 0!==_b?_b:void 0}return yield(0,fetch_1._request)(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt,xform:fetch_1._userResponse})}catch(error){if((0,errors_1.isAuthError)(error))return{data:{user:null},error};throw error;}})}updateUser(attributes,options={}){return __awaiter(this,void 0,void 0,function*(){try{const {data:sessionData,error:sessionError}=yield this.getSession();if(sessionError)throw sessionError;if(!sessionData.session)throw new errors_1.AuthSessionMissingError;const session=
sessionData.session,{data,error:userError}=yield(0,fetch_1._request)(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:null===options||void 0===options?void 0:options.emailRedirectTo,body:attributes,jwt:session.access_token,xform:fetch_1._userResponse});if(userError)throw userError;session.user=data.user;yield this._saveSession(session);this._notifyAllSubscribers("USER_UPDATED",session);return{data:{user:session.user},error:null}}catch(error){if((0,errors_1.isAuthError)(error))return{data:{user:null},
error};throw error;}})}_decodeJWT(jwt){return(0,helpers_1.decodeJWTPayload)(jwt)}setSession(currentSession){return __awaiter(this,void 0,void 0,function*(){try{if(!currentSession.access_token||!currentSession.refresh_token)throw new errors_1.AuthSessionMissingError;const timeNow=Date.now()/1E3;let expiresAt=timeNow,hasExpired=!0,session=null;const payload=(0,helpers_1.decodeJWTPayload)(currentSession.access_token);payload.exp&&(expiresAt=payload.exp,hasExpired=expiresAt<=timeNow);if(hasExpired){const {session:refreshedSession,
error}=yield this._callRefreshToken(currentSession.refresh_token);if(error)return{data:{user:null,session:null},error};if(!refreshedSession)return{data:{user:null,session:null},error:null};session=refreshedSession}else{const {data,error}=yield this.getUser(currentSession.access_token);if(error)throw error;session={access_token:currentSession.access_token,refresh_token:currentSession.refresh_token,user:data.user,token_type:"bearer",expires_in:expiresAt-timeNow,expires_at:expiresAt};yield this._saveSession(session);
this._notifyAllSubscribers("SIGNED_IN",session)}return{data:{user:session.user,session},error:null}}catch(error){if((0,errors_1.isAuthError)(error))return{data:{session:null,user:null},error};throw error;}})}refreshSession(currentSession){var _a;return __awaiter(this,void 0,void 0,function*(){try{if(!currentSession){const {data,error}=yield this.getSession();if(error)throw error;currentSession=null!==(_a=data.session)&&void 0!==_a?_a:void 0}if(null===currentSession||void 0===currentSession||!currentSession.refresh_token)throw new errors_1.AuthSessionMissingError;
const {session,error:error$jscomp$0}=yield this._callRefreshToken(currentSession.refresh_token);return error$jscomp$0?{data:{user:null,session:null},error:error$jscomp$0}:session?{data:{user:session.user,session},error:null}:{data:{user:null,session:null},error:null}}catch(error){if((0,errors_1.isAuthError)(error))return{data:{user:null,session:null},error};throw error;}})}_getSessionFromUrl(isPKCEFlow){return __awaiter(this,void 0,void 0,function*(){try{if(!(0,helpers_1.isBrowser)())throw new errors_1.AuthImplicitGrantRedirectError("No browser detected.");
if("implicit"===this.flowType&&!this._isImplicitGrantFlow())throw new errors_1.AuthImplicitGrantRedirectError("Not a valid implicit grant flow url.");if("pkce"==this.flowType&&!isPKCEFlow)throw new errors_1.AuthPKCEGrantCodeExchangeError("Not a valid PKCE flow url.");if(isPKCEFlow){const authCode=(0,helpers_1.getParameterByName)("code");if(!authCode)throw new errors_1.AuthPKCEGrantCodeExchangeError("No code detected.");const {data,error}=yield this.exchangeCodeForSession(authCode);if(error)throw error;
if(!data.session)throw new errors_1.AuthPKCEGrantCodeExchangeError("No session detected.");return{data:{session:data.session,redirectType:null},error:null}}const error_description=(0,helpers_1.getParameterByName)("error_description");if(error_description){const error_code=(0,helpers_1.getParameterByName)("error_code");if(!error_code)throw new errors_1.AuthImplicitGrantRedirectError("No error_code detected.");const error=(0,helpers_1.getParameterByName)("error");if(!error)throw new errors_1.AuthImplicitGrantRedirectError("No error detected.");
throw new errors_1.AuthImplicitGrantRedirectError(error_description,{error,code:error_code});}const provider_token=(0,helpers_1.getParameterByName)("provider_token"),provider_refresh_token=(0,helpers_1.getParameterByName)("provider_refresh_token"),access_token=(0,helpers_1.getParameterByName)("access_token");if(!access_token)throw new errors_1.AuthImplicitGrantRedirectError("No access_token detected.");const expires_in=(0,helpers_1.getParameterByName)("expires_in");if(!expires_in)throw new errors_1.AuthImplicitGrantRedirectError("No expires_in detected.");
const refresh_token=(0,helpers_1.getParameterByName)("refresh_token");if(!refresh_token)throw new errors_1.AuthImplicitGrantRedirectError("No refresh_token detected.");const token_type=(0,helpers_1.getParameterByName)("token_type");if(!token_type)throw new errors_1.AuthImplicitGrantRedirectError("No token_type detected.");const expires_at=Math.round(Date.now()/1E3)+parseInt(expires_in),{data:data$jscomp$0,error:error$jscomp$0}=yield this.getUser(access_token);if(error$jscomp$0)throw error$jscomp$0;
const user=data$jscomp$0.user,session={provider_token,provider_refresh_token,access_token,expires_in:parseInt(expires_in),expires_at,refresh_token,token_type,user},redirectType=(0,helpers_1.getParameterByName)("type");window.location.hash="";return{data:{session,redirectType},error:null}}catch(error){if((0,errors_1.isAuthError)(error))return{data:{session:null,redirectType:null},error};throw error;}})}_isImplicitGrantFlow(){return(0,helpers_1.isBrowser)()&&(!!(0,helpers_1.getParameterByName)("access_token")||
!!(0,helpers_1.getParameterByName)("error_description"))}_isPKCEFlow(){return __awaiter(this,void 0,void 0,function*(){const currentStorageContent=yield(0,helpers_1.getItemAsync)(this.storage,`${this.storageKey}-code-verifier`);return(0,helpers_1.isBrowser)()&&!!(0,helpers_1.getParameterByName)("code")&&!!currentStorageContent})}signOut(){var _a;return __awaiter(this,void 0,void 0,function*(){const {data,error:sessionError}=yield this.getSession();if(sessionError)return{error:sessionError};var accessToken=
null===(_a=data.session)||void 0===_a?void 0:_a.access_token;if(accessToken&&({error:accessToken}=yield this.admin.signOut(accessToken),accessToken&&(!(0,errors_1.isAuthApiError)(accessToken)||404!==accessToken.status&&401!==accessToken.status)))return{error:accessToken};yield this._removeSession();this._notifyAllSubscribers("SIGNED_OUT",null);return{error:null}})}onAuthStateChange(callback){const id=(0,helpers_1.uuid)();callback={id,callback,unsubscribe:()=>{this.stateChangeEmitters.delete(id)}};
this.stateChangeEmitters.set(id,callback);this.emitInitialSession(id);return{data:{subscription:callback}}}emitInitialSession(id){var _a,_b;return __awaiter(this,void 0,void 0,function*(){try{const {data:{session},error}=yield this.getSession();if(error)throw error;null===(_a=this.stateChangeEmitters.get(id))||void 0===_a?void 0:_a.callback("INITIAL_SESSION",session)}catch(err){null===(_b=this.stateChangeEmitters.get(id))||void 0===_b?void 0:_b.callback("INITIAL_SESSION",null),console.error(err)}})}resetPasswordForEmail(email,
options={}){return __awaiter(this,void 0,void 0,function*(){var codeChallenge=null;"pkce"===this.flowType&&(codeChallenge=(0,helpers_1.generatePKCEVerifier)(),yield(0,helpers_1.setItemAsync)(this.storage,`${this.storageKey}-code-verifier`,codeChallenge),codeChallenge=yield(0,helpers_1.generatePKCEChallenge)(codeChallenge));try{return yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/recover`,{body:{email,code_challenge:codeChallenge,code_challenge_method:codeChallenge?"s256":null,gotrue_meta_security:{captcha_token:options.captchaToken}},
headers:this.headers,redirectTo:options.redirectTo})}catch(error){if((0,errors_1.isAuthError)(error))return{data:null,error};throw error;}})}_refreshAccessToken(refreshToken){return __awaiter(this,void 0,void 0,function*(){try{const startedAt=Date.now();return yield(0,helpers_1.retryable)(attempt=>__awaiter(this,void 0,void 0,function*(){yield(0,helpers_1.sleep)(200*attempt);return yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:refreshToken},
headers:this.headers,xform:fetch_1._sessionResponse})}),(attempt,_,result)=>result&&result.error&&result.error instanceof errors_1.AuthRetryableFetchError&&1E4>Date.now()+200*(attempt+1)-startedAt)}catch(error){if((0,errors_1.isAuthError)(error))return{data:{session:null,user:null},error};throw error;}})}_isValidSession(maybeSession){return"object"===typeof maybeSession&&null!==maybeSession&&"access_token"in maybeSession&&"refresh_token"in maybeSession&&"expires_at"in maybeSession}_handleProviderSignIn(provider,
options){return __awaiter(this,void 0,void 0,function*(){const url=yield this._getUrlForProvider(provider,{redirectTo:options.redirectTo,scopes:options.scopes,queryParams:options.queryParams});(0,helpers_1.isBrowser)()&&!options.skipBrowserRedirect&&window.location.assign(url);return{data:{provider,url},error:null}})}_recoverAndRefresh(){var _a;return __awaiter(this,void 0,void 0,function*(){try{const currentSession=yield(0,helpers_1.getItemAsync)(this.storage,this.storageKey);if(this._isValidSession(currentSession)){var timeNow=
Math.round(Date.now()/1E3);if((null!==(_a=currentSession.expires_at)&&void 0!==_a?_a:Infinity)<timeNow+constants_1.EXPIRY_MARGIN)if(this.autoRefreshToken&&currentSession.refresh_token){const {error}=yield this._callRefreshToken(currentSession.refresh_token);error&&(console.log(error.message),yield this._removeSession())}else yield this._removeSession();else this.persistSession&&(yield this._saveSession(currentSession)),this._notifyAllSubscribers("SIGNED_IN",currentSession)}else null!==currentSession&&
(yield this._removeSession())}catch(err){console.error(err)}})}_callRefreshToken(refreshToken){var _a,_b;return __awaiter(this,void 0,void 0,function*(){if(this.refreshingDeferred)return this.refreshingDeferred.promise;try{this.refreshingDeferred=new helpers_1.Deferred;if(!refreshToken)throw new errors_1.AuthSessionMissingError;const {data,error}=yield this._refreshAccessToken(refreshToken);if(error)throw error;if(!data.session)throw new errors_1.AuthSessionMissingError;yield this._saveSession(data.session);
this._notifyAllSubscribers("TOKEN_REFRESHED",data.session);var result={session:data.session,error:null};this.refreshingDeferred.resolve(result);return result}catch(error){if((0,errors_1.isAuthError)(error))return result={session:null,error},null===(_a=this.refreshingDeferred)||void 0===_a?void 0:_a.resolve(result),result;null===(_b=this.refreshingDeferred)||void 0===_b?void 0:_b.reject(error);throw error;}finally{this.refreshingDeferred=null}})}_notifyAllSubscribers(event,session,broadcast=!0){this.broadcastChannel&&
broadcast&&this.broadcastChannel.postMessage({event,session});this.stateChangeEmitters.forEach(x=>x.callback(event,session))}_saveSession(session){return __awaiter(this,void 0,void 0,function*(){this.persistSession||(this.inMemorySession=session);this.persistSession&&session.expires_at&&(yield this._persistSession(session))})}_persistSession(currentSession){return(0,helpers_1.setItemAsync)(this.storage,this.storageKey,currentSession)}_removeSession(){return __awaiter(this,void 0,void 0,function*(){this.persistSession?
yield(0,helpers_1.removeItemAsync)(this.storage,this.storageKey):this.inMemorySession=null})}_removeVisibilityChangedCallback(){const callback=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{callback&&(0,helpers_1.isBrowser)()&&(null===window||void 0===window?0:window.removeEventListener)&&window.removeEventListener("visibilitychange",callback)}catch(e){console.error("removing visibilitychange callback failed",e)}}_startAutoRefresh(){return __awaiter(this,void 0,void 0,function*(){yield this._stopAutoRefresh();
const ticker=setInterval(()=>this._autoRefreshTokenTick(),1E4);(this.autoRefreshTicker=ticker)&&"object"===typeof ticker&&"function"===typeof ticker.unref?ticker.unref():"undefined"!==typeof Deno&&"function"===typeof Deno.unrefTimer&&Deno.unrefTimer(ticker);yield this._autoRefreshTokenTick()})}_stopAutoRefresh(){return __awaiter(this,void 0,void 0,function*(){const ticker=this.autoRefreshTicker;this.autoRefreshTicker=null;ticker&&clearInterval(ticker)})}startAutoRefresh(){return __awaiter(this,void 0,
void 0,function*(){this._removeVisibilityChangedCallback();yield this._startAutoRefresh()})}stopAutoRefresh(){return __awaiter(this,void 0,void 0,function*(){this._removeVisibilityChangedCallback();yield this._stopAutoRefresh()})}_autoRefreshTokenTick(){return __awaiter(this,void 0,void 0,function*(){const now=Date.now();try{const {data:{session}}=yield this.getSession();session&&session.refresh_token&&session.expires_at&&3>Math.floor((1E3*session.expires_at-now)/1E4)&&(yield this._callRefreshToken(session.refresh_token))}catch(e){console.error("Auto refresh tick failed with error. This is likely a transient error.",
e)}})}_handleVisibilityChange(){return __awaiter(this,void 0,void 0,function*(){if(!(0,helpers_1.isBrowser)()||null===window||void 0===window||!window.addEventListener)return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=()=>__awaiter(this,void 0,void 0,function*(){return yield this._onVisibilityChanged(!1)}),null===window||void 0===window?void 0:window.addEventListener("visibilitychange",this.visibilityChangedCallback),yield this._onVisibilityChanged(!0)}catch(error){console.error("_handleVisibilityChange",
error)}})}_onVisibilityChanged(isInitial){return __awaiter(this,void 0,void 0,function*(){"visible"===document.visibilityState?(isInitial||(yield this.initializePromise,yield this._recoverAndRefresh()),this.autoRefreshToken&&this._startAutoRefresh()):"hidden"===document.visibilityState&&this.autoRefreshToken&&this._stopAutoRefresh()})}_getUrlForProvider(provider,options){return __awaiter(this,void 0,void 0,function*(){const urlParams=[`provider=${encodeURIComponent(provider)}`];(null===options||void 0===
options?0:options.redirectTo)&&urlParams.push(`redirect_to=${encodeURIComponent(options.redirectTo)}`);(null===options||void 0===options?0:options.scopes)&&urlParams.push(`scopes=${encodeURIComponent(options.scopes)}`);if("pkce"===this.flowType){var codeVerifier=(0,helpers_1.generatePKCEVerifier)();yield(0,helpers_1.setItemAsync)(this.storage,`${this.storageKey}-code-verifier`,codeVerifier);codeVerifier=yield(0,helpers_1.generatePKCEChallenge)(codeVerifier);codeVerifier=new URLSearchParams({code_challenge:`${encodeURIComponent(codeVerifier)}`,
code_challenge_method:`${encodeURIComponent("s256")}`});urlParams.push(codeVerifier.toString())}if(null===options||void 0===options?0:options.queryParams)codeVerifier=new URLSearchParams(options.queryParams),urlParams.push(codeVerifier.toString());return`${this.url}/authorize?${urlParams.join("\x26")}`})}_unenroll(params){var _a;return __awaiter(this,void 0,void 0,function*(){try{const {data:sessionData,error:sessionError}=yield this.getSession();return sessionError?{data:null,error:sessionError}:
yield(0,fetch_1._request)(this.fetch,"DELETE",`${this.url}/factors/${params.factorId}`,{headers:this.headers,jwt:null===(_a=null===sessionData||void 0===sessionData?void 0:sessionData.session)||void 0===_a?void 0:_a.access_token})}catch(error){if((0,errors_1.isAuthError)(error))return{data:null,error};throw error;}})}_enroll(params){var _a,_b;return __awaiter(this,void 0,void 0,function*(){try{const {data:sessionData,error:sessionError}=yield this.getSession();if(sessionError)return{data:null,error:sessionError};
const {data,error}=yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/factors`,{body:{friendly_name:params.friendlyName,factor_type:params.factorType,issuer:params.issuer},headers:this.headers,jwt:null===(_a=null===sessionData||void 0===sessionData?void 0:sessionData.session)||void 0===_a?void 0:_a.access_token});if(error)return{data:null,error};if(null===(_b=null===data||void 0===data?void 0:data.totp)||void 0===_b?0:_b.qr_code)data.totp.qr_code=`data:image/svg+xml;utf-8,${data.totp.qr_code}`;
return{data,error:null}}catch(error){if((0,errors_1.isAuthError)(error))return{data:null,error};throw error;}})}_verify(params){var _a;return __awaiter(this,void 0,void 0,function*(){try{const {data:sessionData,error:sessionError}=yield this.getSession();if(sessionError)return{data:null,error:sessionError};const {data,error}=yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/factors/${params.factorId}/verify`,{body:{code:params.code,challenge_id:params.challengeId},headers:this.headers,jwt:null===
(_a=null===sessionData||void 0===sessionData?void 0:sessionData.session)||void 0===_a?void 0:_a.access_token});if(error)return{data:null,error};yield this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1E3)+data.expires_in},data));this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",data);return{data,error}}catch(error){if((0,errors_1.isAuthError)(error))return{data:null,error};throw error;}})}_challenge(params){var _a;return __awaiter(this,void 0,void 0,function*(){try{const {data:sessionData,
error:sessionError}=yield this.getSession();return sessionError?{data:null,error:sessionError}:yield(0,fetch_1._request)(this.fetch,"POST",`${this.url}/factors/${params.factorId}/challenge`,{headers:this.headers,jwt:null===(_a=null===sessionData||void 0===sessionData?void 0:sessionData.session)||void 0===_a?void 0:_a.access_token})}catch(error){if((0,errors_1.isAuthError)(error))return{data:null,error};throw error;}})}_challengeAndVerify(params){return __awaiter(this,void 0,void 0,function*(){const {data:challengeData,
error:challengeError}=yield this._challenge({factorId:params.factorId});return challengeError?{data:null,error:challengeError}:yield this._verify({factorId:params.factorId,challengeId:challengeData.id,code:params.code})})}_listFactors(){return __awaiter(this,void 0,void 0,function*(){const {data:{user},error:userError}=yield this.getUser();if(userError)return{data:null,error:userError};const factors=(null===user||void 0===user?void 0:user.factors)||[],totp=factors.filter(factor=>"totp"===factor.factor_type&&
"verified"===factor.status);return{data:{all:factors,totp},error:null}})}_getAuthenticatorAssuranceLevel(){var _a,_b;return __awaiter(this,void 0,void 0,function*(){const {data:{session},error:sessionError}=yield this.getSession();if(sessionError)return{data:null,error:sessionError};if(!session)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const payload=this._decodeJWT(session.access_token);let currentLevel=null;payload.aal&&(currentLevel=payload.aal);
let nextLevel=currentLevel;0<(null!==(_b=null===(_a=session.user.factors)||void 0===_a?void 0:_a.filter(factor=>"verified"===factor.status))&&void 0!==_b?_b:[]).length&&(nextLevel="aal2");return{data:{currentLevel,nextLevel,currentAuthenticationMethods:payload.amr||[]},error:null}})}}exports.default=GoTrueClient}
//# sourceMappingURL=module$node_modules$$supabase$gotrue_js$dist$main$GoTrueClient.js.map
